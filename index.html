<!DOCTYPE html>
<html lang="en">
<head>
	<title>Triangle game</title>
	<meta charset="UTF-8" />
	<script type="text/javascript" src="kinetic-v4.5.5.min.js"></script>
	<script type="text/javascript" src="jquery.min.js"></script>
  
  <style>
  * {
    margin: 0;
    padding: 0;
  }
  body {
    height: 100%;
    width: 100%;
    background-color: #1c253e;
    position: absolute;
    bottom: 0;
    top: 0;
    overflow: hidden;
  }
  #game {
    width: 100%; 
    height: 100%; 
    position: relative;
    z-index: 5;
  }
  </style>
</head>
<body>
	<div id="game"></div>
	
	<script type="text/javascript">
  
	// canvas dimensions
	var width = $('#game').width();
	var height = $('#game').height();

  function getRandom(min, max) {
      return min + Math.floor(Math.random() * (max - min + 1));
  }

  var player = {};
  player.forward = false;
  player.backward = false;
  player.left = false;
  player.right = false;
  player.shooting = false;
  
  // vars
  player.forward_force; // todo
  player.mass; // todo
  player.FWD_ACC = 4; // px/s
  player.ROT_ACC = 8; // deg/s
  
  player.velocity = {x: 0, y: 0, rot: 0};
  player.acceleration = {x: 0, y: 0, rot: 0};
  
  player.step = function(tdiff){
    
    xrot = Math.cos(player.ship.getRotation()+Math.PI/2);
    yrot = Math.sin(player.ship.getRotation()+Math.PI/2);
    
    // acc
    if (player.forward){
      player.acceleration.x = player.FWD_ACC * xrot;
      player.acceleration.y = player.FWD_ACC * yrot;
    } else if (player.backward) {
      player.acceleration.x = -player.FWD_ACC * xrot;
      player.acceleration.y = -player.FWD_ACC * yrot;
    } else {
      player.acceleration.x = 0;
      player.acceleration.y = 0;
    }
    
    if (player.left){
      player.acceleration.rot = -player.ROT_ACC;
    } else if (player.right) {
      player.acceleration.rot = player.ROT_ACC;
    } else {
      player.acceleration.rot = 0;
    }
    
    // vel
    player.velocity.x += player.acceleration.x * tdiff;
    player.velocity.y += player.acceleration.y * tdiff;
    player.velocity.rot += player.acceleration.rot * tdiff * 0.9;
    
    if (player.brake){
      player.velocity.x *= 0.9;
      player.velocity.y *= 0.9;
      player.velocity.rot *= 0.9;
      
    }
    
    // pos
    player.ship.setX(player.ship.getX() + player.velocity.x);
    player.ship.setY(player.ship.getY() + player.velocity.y);
    player.ship.setRotationDeg(player.ship.getRotationDeg() + player.velocity.rot);
    
    
    // wrap
    // left
    if (player.ship.getX() < -50) {
      player.ship.setX(player.ship.getX() + width + 100)
    }
    // top
    if (player.ship.getY() < -50) {
      player.ship.setY(player.ship.getY() + height + 100)
    }
    // right
    if (player.ship.getX() > width + 50) {
      player.ship.setX(player.ship.getX() - width - 100)
    }
    // bottom
    if (player.ship.getY() > height + 50) {
      player.ship.setY(player.ship.getY() - height - 100)
    }
    
    
  }

	window.onload = function() {

    var shipheight = 50;
    var shipwidth = 30;

    var stage = new Kinetic.Stage({
      container: 'game',
      width: width,
      height: height
    });

    var layer = new Kinetic.Layer();
    
    // create shape
    player.ship = new Kinetic.Polygon({
      points: [
        [0, shipheight*2/3], 
        [-shipwidth/2, -shipheight/3], 
        [shipwidth/2, -shipheight/3]
      ],
      fill: '#000000',
      strokeWidth: 3,
      stroke: '#ffffff'
    });

    layer.add(player.ship);

    console.log(player)

    // add the layer to the stage
    stage.add(layer);

    player.ship.setX(width/2);
    player.ship.setY(height/2);
    player.ship.setRotationDeg(180);
    
    var anim = new Kinetic.Animation(function(frame) {
      tdiff = frame.timeDiff/1000;
      player.step(tdiff);    
    }, layer);

    anim.start();
    
    function keyDownHandler(event){
      switch (event.which) {
        case 38: 
          player.forward = true;
          break;
        case 40:
          player.backward = true;
          break;
        case 37:
          player.left = true;
          break;
        case 39:
          player.right = true;
          break;
        case 32:
          player.shooting = true;
          break;
        case 88: // x
          player.brake = true;
          break;
        default:
        console.log(event.which);
      }
    }
    
    function keyUpHandler(event){      
      switch (event.which) {
        case 38: 
          player.forward = false;
          break;
        case 40:
          player.backward = false;
          break;
        case 37:
          player.left = false;
          break;
        case 39:
          player.right = false;
          break;
        case 32:
          player.shooting = false;
          break;
        case 88: // x
          player.brake = false;
          break;
      }
    }
    
    $(document).keydown(keyDownHandler);
    $(document).keyup(keyUpHandler);
    
	};
	
	
	</script>
</body>